#! /bin/bash
# prerequisites: libvips http://www.vips.ecs.soton.ac.uk
# http://www.vips.ecs.soton.ac.uk/supported/current/doc/html/libvips/libvips-resample.html#vips-resize

# filename should looks like: `filename.jpg`

cwd=$(pwd)
# re='_([0-9]{2,4})\.(jpg|png)'
re='\.(jpg|png)'

resize()
{
  new_width=$(echo $(vipsheader $1 -f width)*$2 | bc)
  ext=$(echo ${1##*.})
  new_filename=$(echo "${1//$(echo $1 | grep -ioE $re)}")
  result=$new_filename"_"$new_width"@"$2"x".$ext
  vips resize $filename $result $2
}

for f in $cwd/*; do
  path=$(basename "$f")
  filename=$(echo $path | grep -iE $re)
  if [[ $filename ]]; then
    resize $filename '2' && resize $filename '3'
  fi
done
