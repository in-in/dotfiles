---
# create lists
- name: create lists
  set_fact:
    '{{ item }}_list': '{{
      hostvars.localhost
      | json_query(''*.'' + item + '''')
      | list
    }}'
  with_items: '{{ utility_task_list }}'

# add keys
- name: add keys
  become: yes
  apt_key:
    url: '{{ item }}'
  with_items: '{{ add_key_filename_list }}'

# add an external repositories
- name: add an external repositories
  become: yes
  apt_repository:
    repo: '{{ item }}'
    update_cache: yes
  with_items: '{{ add_repository_sourceline_list }}'

# add packages
- name: add packages
  become: yes
  apt:
    force_apt_get: yes
    name: '{{ item }}'
    state: latest
  with_items: '{{ add_package_name_list }}'

# git repository
- name: git repository | collect stat
  stat:
    path: '{{ item.dest }}'
  register: dir
  with_items: '{{ add_git_repository_list }}'

- name: git repository | remove existing directory
  file:
    path: '{{ item.item.dest }}'
    force: yes
    state: absent
  when: item.stat.exists and item.stat.isdir
  with_items: '{{ dir.results }}'

- name: git repository | add repository
  git:
    repo: '{{ item.repo }}'
    dest: '{{ item.dest }}'
  with_items: '{{ add_git_repository_list }}'

# link
- name: link | collect stat
  stat:
    path: '{{ item.dest }}'
  register: dir
  with_items: '{{ add_link_list }}'

- name: link | remove existing directory
  file:
    path: '{{ item.item.dest }}'
    state: absent
  when: item.stat.exists and item.stat.isdir
  with_items: '{{ dir.results }}'

- name: link | create link
  file:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    force: yes
    state: link
  with_items: '{{ add_link_list }}'

# gitignore
- name: gitignore | create tmp directory
  file:
    path: '{{ gitignore_tmp }}'
    state: directory
    force: yes

- name: gitignore | create template
  template:
    src: gitignore.j2
    dest: '{{ gitignore_tmp }}/{{ item.0 }}'
  with_indexed_items: '{{ add_gitignore_list }}'

- name: gitignore | create main gitignore file
  assemble:
    src: '{{ gitignore_tmp }}'
    dest: '{{ dotfiles_directory }}/.gitignore'
    delimiter: '\n'

# autostartup
- name: autostartup | collect stat
  stat:
    path: '{{ startup_dest }}'
  register: result

- name: autostartup | recreate directory
  block:
    - file:
        path: '{{ startup_dest }}'
        state: absent
    - file:
        path: '{{ startup_dest }}'
        state: directory
  when: result.stat.isdir is defined

- name: autostartup | create directory
  file:
    path: '{{ startup_dest }}'
    state: directory
  when: result.stat.isdir is not defined

- name: autostartup | create template file
  template:
    src: 'startup.j2'
    dest: '{{ startup_dest }}/{{ item.name }}.desktop'
  with_items: '{{ add_startup_list }}'

# copy
- name: copy | collect stat
  stat:
    path: '{{ item.dir }}'
  register: result
  when: item.dir is defined
  with_items: '{{ utility_copy_list }}'

- name: copy | remove existing directory
  file:
    path: '{{ item.stat.path }}'
    state: absent
  when:
    - item is not skipped
    - item.stat.exists
    - item.stat.isdir is defined
  with_items: '{{ result.results }}'

- name: copy | with privilege
  become: yes
  copy:
    backup: yes
    src: '{{ item.1.src }}'
    dest: '{{ item.1.dest }}'
  when: item.0.privilege is defined
  with_subelements:
    - '{{ utility_copy_list }}'
    - paths

- name: copy | without privilege
  copy:
    backup: yes
    src: '{{ item.1.src }}'
    dest: '{{ item.1.dest }}'
  when: item.0.privilege is not defined
  with_subelements:
    - '{{ utility_copy_list }}'
    - paths
