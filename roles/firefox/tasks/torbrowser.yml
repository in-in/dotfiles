- import_tasks: "{{ helpers }}/tempfile.yml"
  tags: "tempfile_torbrowser"

- name: torbrowser | get release file
  get_url:
    url: https://aus1.torproject.org/torbrowser/update_3/release/Linux_x86_64-gcc3/x/en-US
    dest: '{{ helper_tempfile_result }}'
  register: get_url_result
  until: not get_url_result.failed
  retries: 10
  delay: 10
  tags: "torbrowser_get_url"

- name: torbrowser | get app version
  xml:
    path: '{{ get_url_result.dest }}'
    xpath: /updates/update
    content: attribute
  register: xml_result
  tags: "torbrowser_get_version"

- name: torbrowser | create task variables
  vars:
    torbrowser_version: "{{ xml_result.matches[0]['update'].appVersion }}"
  set_fact:
    torbrowser_archive_link: |-
      {{
        "https://www.torproject.org/dist/torbrowser/" ~
        torbrowser_version ~
        "/tor-browser-linux64-" ~
        torbrowser_version ~
        "_en-US.tar.xz"
      }}

- name: torbrowser | download and unarchive files
  unarchive:
    src: "{{ torbrowser_archive_link }}"
    dest: "{{ tor_browser_dir }}"
    extra_opts:
      - --one-top-level=torbrowser
      - --strip-components=1
    remote_src: True
  register: unarchive_result
  until: not unarchive_result.failed
  retries: 10
  delay: 10
  tags: "torbrowser_unarchive"

- name: torbrowser | create symlink
  file:
    src: "{{ tor_browser_dir }}/torbrowser/start-tor-browser.desktop"
    dest: "{{ user_home }}/.local/share/applications/torbrowser.desktop"
    force: True
    state: link
  tags: "torbrowser_file"
