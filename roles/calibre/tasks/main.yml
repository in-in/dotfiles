---
# TODO: I only need 'ebook-viewer', but I have to download the whole Calibre

- name: run template helper
  import_tasks: '{{ helpers }}/template.yml'
  vars:
    template_facts:
      - src: 'viewer.py'
        dest: '{{ user_config }}/calibre'

- name: run tempfile helper
  import_tasks: '{{ helpers }}/tempfile.yml'
  vars:
    tempfile_suffix: '.calibre'

- name: get the installer
  get_url:
    url: '{{ calibre_installer }}'
    dest: '{{ helper_tempfile_result.path }}'
  register: get_url_result
  until: get_url_result.msg is match('OK*')
  retries: 10
  delay: 10

- name: install
  become: yes
  script: '{{ helper_tempfile_result.path }}/{{ calibre_installer | basename }}'

- name: run mime helper
  import_tasks: '{{ helpers }}/mime.yml'
  vars:
    mime_facts:
      entry_name: 'calibre-ebook-viewer'
      type:
        - 'application/epub+zip'
