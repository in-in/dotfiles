---
- set_fact:
    hotspot_name: 'hotspot_{{ ansible_hostname | to_uuid() | truncate(4, True, "") }}'

- name: hotspot | get connection status
  command: nmcli -t connection show
  register: nmcli_connection_result
  changed_when: false

- block:
    - name: hotspot | delete hotspot connection
      command: >
        nmcli connection delete {{ hotspot_name }}
      when: hotspot_name in item
      loop: '{{ nmcli_connection_result.stdout_lines }}'
  rescue:
    - name: hotspot | unable to find connection
      debug:
        msg: 'unable to find connection'

- name: hotspot | add hotspot connection
  command: >
    nmcli connection add
    type 802-11-wireless
    ifname ''
    con-name {{ hotspot_name }}
    connection.autoconnect no
    wifi.ssid {{ hotspot_name }}
    wifi.mode ap
    wifi-sec.key-mgmt wpa-psk
    wifi-sec.psk {{ lookup('password', '/dev/null chars=ascii_letters,digits length=10') }}
    ipv4.method shared
    ipv6.method shared
    ipv6.ip6-privacy 1
