- import_tasks: "{{ helpers }}/package_apt_add.yml"
  vars:
    package_apt_add_facts:
      - "fonts-roboto-hinted"
      - "fonts-roboto-slab"

- import_tasks: "{{ helpers }}/latest_release.yml"
  vars:
    latest_release_facts:
      owner: "be5invis"
      repo: "iosevka"
      pattern: "(ss08)"
  tags:
    - "latest_release_font"
    - "update_font"

- import_tasks: "{{ helpers }}/dir_create.yml"
  become: True
  vars:
    dir_create_facts:
      - path: |-
        {{
          q('items', helper_latest_release_result)
          | selectattr('id', 'equalto', role_name)
          | map(attribute='url')
          | map('basename')
          | map('splitext')
          | map('first')
          | map('regex_replace', '^', font_default_dir)
          | list
        }}
  tags:
    - "dir_create_font"
    - "update_font"

- name: download and unarchive files
  become: True
  unarchive:
    src: "{{ item.url }}"
    dest: |-
      {{
        font_default_dir
        ~ item.url
        | basename
        | splitext
        | first
      }}
    remote_src: True
  register: unarchive_result
  until: not unarchive_result.failed
  retries: 10
  delay: 10
  when: item.id == role_name
  loop: "{{ helper_latest_release_result }}"
  tags:
    - "unarchive_font"
    - "update_font"
