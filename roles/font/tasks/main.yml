- import_tasks: "{{ helpers }}/package_apt.yml"
  vars:
    package_apt_facts:
      install:
        - "fonts-roboto-hinted"
        - "fonts-roboto-slab"

- import_tasks: "{{ helpers }}/latest_release.yml"
  vars:
    latest_release_facts:
      owner: "be5invis"
      repo: "iosevka"
      pattern: "(ss08)"
  tags:
    - "latest_release_font"
    - "update_font"

- import_tasks: "{{ helpers }}/dir_create.yml"
  become: True
  vars:
    dir_create_facts: |-
      {{
        q('items', helper_latest_release_result)
        | selectattr('id', 'equalto', role_name)
        | map(attribute='url')
        | map('basename')
        | map('splitext')
        | map('first')
        | map('regex_replace', '^', '/usr/local/share/fonts/')
        | list
      }}
  tags:
    - "dir_create_font"
    - "update_font"

- name: download and unarchive files
  become: True
  unarchive:
    src: "{{ item.url }}"
    dest: |-
      {{
        '/usr/local/share/fonts/'
        ~ item.url
        | basename
        | splitext
        | first
      }}
    remote_src: True
  register: unarchive_result
  until: not unarchive_result.failed
  retries: 10
  delay: 10
  when: item.id == role_name
  loop: "{{ helper_latest_release_result }}"
  tags:
    - "unarchive_font"
    - "update_font"
