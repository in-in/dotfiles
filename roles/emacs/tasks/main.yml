---
- name: run repo helper
  import_tasks: '{{ helpers }}/repo.yml'
  vars:
    repo_facts:
      - repo: 'ppa:kelleyk/emacs'

- name: run package helper
  import_tasks: '{{ helpers }}/package_apt.yml'
  vars:
    package_apt_facts:
      install:
        - 'emacs25'

- name: run template helper
  import_tasks: '{{ helpers }}/template.yml'
  vars:
    template_facts:
      - src: 'init.el'
        dest: '{{ user_home }}/.emacs.d'
      - src: 'custom.el'
        dest: '{{ user_home }}/.emacs.d/custom'
      - src: 'ui.el'
        dest: '{{ user_home }}/.emacs.d/custom'
      - src: 'use_package.el'
        dest: '{{ user_home }}/.emacs.d/custom'
  tags:
    - 'user_font'
    - 'template_emacs'

- name: configure
  block:
    - name: run init file
      command: 'emacs --script init.el'
      args:
        chdir: '{{ user_home }}/.emacs.d'
        removes: 'init.el'
      register: command_result
      until: command_result.failed == false
      retries: 10
      delay: 10
  rescue:
    - name: cannot run init file
      debug:
        msg: 'Cannot run init file'
