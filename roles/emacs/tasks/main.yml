---
- name: run repo helper
  import_tasks: '{{ helpers }}/repo.yml'
  vars:
    repo_list:
      - repo: 'ppa:kelleyk/emacs'

- name: run package helper
  import_tasks: '{{ helpers }}/package_apt.yml'
  vars:
    package_apt_list:
      install:
        - 'emacs25'

- name: run link helper
  import_tasks: '{{ helpers }}/link.yml'
  vars:
    link_list:
      - src: '{{ dotfiles_roles }}/emacs/files/emacs.d'
        dest: '{{ user_home }}/.emacs.d'

- name: run gitignore helper
  import_tasks: '{{ helpers }}/gitignore.yml'
  vars:
    gitignore_data: "{{ lookup('template', 'gitignore') }}"
  tags: 'emacs_gitignore'

- name: configure
  block:
    - name: run init file
      command: 'emacs --script init.el'
      args:
        chdir: '{{ user_home }}/.emacs.d'
        removes: 'init.el'
      register: command_result
      until: command_result.failed == false
      retries: 10
      delay: 10
  rescue:
    - name: cannot run init file
      debug:
        msg: 'Cannot run init file'
