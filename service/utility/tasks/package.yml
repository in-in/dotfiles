---
#apt
- name: package | apt | install
  become: yes
  apt:
    force_apt_get: yes
    name: '{{ item.apt.install }}'
    state: latest
  register: apt_install_result
  until: apt_install_result.failed == False
  retries: 3
  delay: 10
  when:
    - item.apt is defined
    - item.apt.install is defined
  loop: '{{ q("flattened", utility_package_list) }}'

- name: package | apt | remove
  become: yes
  apt:
    force_apt_get: yes
    purge: yes
    name: '{{ item.apt.remove }}'
    state: absent
  when:
    - item.apt is defined
    - item.apt.remove is defined
  loop: '{{ q("flattened", utility_package_list) }}'

# pip
- name: package | pip | install
  pip:
    name: |-
      {{ item.pip.install
        | map(attribute="name")
        | list
      }}
    extra_args: '--user --upgrade'
    state: latest
  register: pip_install_result
  until: pip_install_result.failed == False
  retries: 3
  delay: 10
  when:
    - item.pip is defined
    - item.pip.install is defined
  loop: '{{ q("flattened", utility_package_list) }}'
