---
- set_fact:
    flat_utility_template: '{{ utility_template_list | flatten }}'

- name: template | collect stat
  include_tasks: '{{ helper_stat }}'
  vars:
    path: '{{ item.dest | default(None) }}'
    object: '{{ flat_utility_template }}'

- name: template | create directory
  include_tasks: '{{ helper_dir_create }}'
  vars:
    path: '{{ item.item.dest }}'
  when: item.stat.exists == false
  loop: '{{ helper_stat_result.results }}'

- name: template | create config
  become: '{{ item.privilege | default(false) }}'
  template:
    src: '{{ item.path }}/{{ item.filename }}.j2'
    dest: '{{ item.dest }}/{{ item.filename }}'
    lstrip_blocks: yes
    backup: yes
  vars:
    data: |-
      {{
        hostvars[inventory_hostname]
        ['global_config_' + item.path.split('/')[-2]]
        [item.data | default(None)] | default(None)
      }}
  loop: '{{ flat_utility_template }}'
