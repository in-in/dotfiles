---
- set_fact:
    flat_utility_template: '{{ utility_template_list | flatten }}'

- name: template | recreate directory
  block:
    - include_tasks: '{{ helper_dir_remove }}'
      vars:
        path: '{{ item.dest }}'
      loop: '{{ flat_utility_template }}'

    - include_tasks: '{{ helper_dir_create }}'
      vars:
        path: '{{ item.dest }}'
      loop: '{{ flat_utility_template }}'

- name: template | create config
  template:
    src: '{{ item.path }}/{{ item.filename }}.j2'
    dest: '{{ item.dest }}/{{ item.filename }}'
    lstrip_blocks: yes
    backup: yes
  vars:
    data: '{{
      hostvars[inventory_hostname]
      ["global_config_" + item.path.split("/")[-2]]
      [item.data | default(None)] | default(None)
      }}'
  loop: '{{ flat_utility_template }}'
