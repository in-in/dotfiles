- &directory
  name: helper | template | create directory
  become: "{{ item.privilege | default(false) }}"
  file: &file
    path: "{{ item.dest }}"
    state: directory
  when:
    - '"privilege" in item'
    - item.dest is not directory
  loop: "{{ template_facts }}"

- &template
  name: helper | template | create template
  become: "{{ item.privilege | default(false) }}"
  template:
    src: "{{ item.src }}"
    dest: |-
      {{ item.dest ~ '/' ~
        (item.filename is defined)
        | ternary(item.filename, item.src | basename)
      }}
    backup: "{{ item.backup | default(false) }}"
    lstrip_blocks: True
  vars:
    data: "{{ item.data | default(None) }}"
  when: '"privilege" in item'
  loop: "{{ template_facts }}"

# without privilege
- <<: *directory
  when: '"privilege" not in item'

- <<: *template
  when: '"privilege" not in item'
