- name: helper | package_apt | create task variable
  set_fact:
    package_list: "{{ q('items', package_apt_facts) }}"

- block:
    - name: helper | package_apt | install package
      apt:
        force_apt_get: True
        install_recommends: '{{ item.install_recommends | default(False) }}'
        name: '{{ item.install }}'
        state: latest
      register: apt_install_result
      until: not apt_install_result.failed
      retries: 10
      delay: 10
      when: item.install is defined
      loop: '{{ package_list }}'

    - name: helper | package_apt | remove package
      apt:
        force_apt_get: True
        purge: True
        name: '{{ item.remove }}'
        state: absent
        autoremove: True
      when: item.remove is defined
      loop: '{{ package_list }}'
  become: True
